variant: fcos
version: 1.4.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCn9eViO+t7rKylit3Olrfbz+YSqLp23dFwKbvSdAw7bAaWE9wT5rmNerG4IWmCd58v2NxcyNpAxbvk9z1TPaoILqw1S3pvBJU4ftnIIna3DbgmZbUp76YZKsVLhCvEZxHlWdw0lebwBsdIKT/4fs2H0D1SSjiem47st0ln3PTEF33mmODsLQWAT1KrzJuJI8Hlm/mlLhH5G1LAeWW8vEGtqaevHRkGvoVdPed8i/w97d7qBxklix28kuXQoegE6B317WVHvRpnOdhGgdKymxaKMuxQJ0RmwHRTnkwz5sPGBw1TrzgQfx2benNpRv1t23cUunM2yZ0qrEhc0+G6sGC1 vrutkovs@locahost
systemd:
  units:
    - name: serial-getty@ttyS0.service
      dropins:
      - name: autologin-core.conf
        contents: |
          [Service]
          # Override Execstart in main unit
          ExecStart=
          # Add new Execstart with `-` prefix to ignore failure`
          ExecStart=-/usr/sbin/agetty --autologin core --noclear %I $TERM
    - name: install-microshift.service
      enabled: true
      contents: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/var/lib/.microshift-installed

        [Service]
        RemainAfterExit=yes
        Type=oneshot
        ExecStart=/usr/local/bin/install-microshift
        StandardOutput=kmsg+console
        StandardError=kmsg+console

        [Install]
        WantedBy=multi-user.target
    - name: adguard.service
      enabled: true
      contents: |
        [Unit]
        Description=adguard
        Wants=network-online.target
        After=network-online.target

        [Service]
        ExecStartPre=-/usr/bin/mkdir /srv/adguard/work
        ExecStartPre=-/usr/bin/podman rm -f adguard
        ExecStartPre=/usr/bin/podman create --rm --name=adguard --privileged  --security-opt label=disable  --net=host -v /srv/adguard/work:/opt/adguardhome/work:z -v /srv/adguard/conf:/opt/adguardhome/conf:z  docker.io/adguard/adguardhome:v0.107.7
        ExecStart=/usr/bin/podman start -a adguard
        ExecStop=-/usr/bin/podman stop -t 10 adguard
        ExecStop=-/usr/bin/podman rm -f adguard
        Restart=always
        RestartSec=60

        [Install]
        WantedBy=multi-user.target
    - name: bootstrap-microshift.service
      enabled: true
      contents: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=/var/lib/.microshift-installed
        ConditionPathExists=!/var/lib/.microshift-provisioned

        [Service]
        RemainAfterExit=yes
        Type=oneshot
        ExecStart=/usr/local/bin/bootstrap-microshift
        StandardOutput=kmsg+console
        StandardError=kmsg+console

        [Install]
        WantedBy=multi-user.target
storage:
  trees:
    - local: manifests
      path: /etc/microshift/manifests
  files:
    - path: /usr/local/bin/install-microshift
      mode: 0755
      contents:
        local: ./scripts/install-microshift.sh
    - path: /usr/local/bin/bootstrap-microshift
      mode: 0755
      contents:
        local: ./scripts/bootstrap-microshift.sh
    - path: /etc/profile.d/systemd-pager.sh
      mode: 0644
      contents:
        inline: |
          # Tell systemd to not use a pager when printing information
          export SYSTEMD_PAGER=cat
    - path: /etc/sysctl.d/20-silence-audit.conf
      mode: 0644
      contents:
        inline: |
          # Raise console message logging level from DEBUG (7) to WARNING (4)
          # to hide audit messages from the interactive console
          kernel.printk=4
    - path: /etc/systemd/resolved.conf.d/no-dns-stub.conf
      mode: 0644
      contents:
        local: ./network/no-dns-stub.conf
    - path: /etc/NetworkManager/system-connections/local-ap.nmconnection
      mode: 0644
      contents:
        local: ./network/local-ap.nmconnection
    - path: /srv/adguard/conf/AdGuardHome.yaml
      mode: 0644
      contents:
        local: ./network/AdGuardHome.yaml
    - path: /etc/systemd/logind.conf.d/prevent-sleep.conf
      mode: 0644
      contents:
        local: ./network/prevent-sleep.conf
    - path: /etc/firewalld/zones/external.xml
      mode: 0644
      contents:
        local: ./network/external.xml
    - path: /etc/firewalld/zones/internal.xml
      mode: 0644
      contents:
        local: ./network/internal.xml
